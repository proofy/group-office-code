/*
 * Ext.ux.PluploadPanel
 * Ext.ux.PluploadButton
 * (c) http://adtim.ru/extjs/ux_plupload
 * 2010-04-28 v0.1
 */
Ext.ux.PluploadPanel=Ext.extend(Ext.Panel,{constructor:function(a){this.autoScroll=false;this.bodyCssClass="x-plupload-body";this.success=[];this.failed=[];this.viewTpl=new Ext.XTemplate('<tpl for=".">','<dl id="{id}">','<dt style="width: 50%">{name}</dt>','<dt style="width: 15%">{size:fileSize}</dt>','<tpl exec="this.statusValue(status, percent, msg)"></tpl><dt style="width: 35%">{this.statusText}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>",{compiled:true,statusText:"-",statusTextQueued:a.statusQueuedText||"Queued",statusTextUploading:a.statusUploadingText||"Uploaded ({0}%)",statusTextFailed:a.statusFailedText||"FAILED",statusTextDone:a.statusDoneText||"DONE",statusValue:function(b,c,d){if(b==1){this.statusText=this.statusTextQueued}else{if(b==2){this.statusText=String.format(this.statusTextUploading,c)}else{if(b==4){this.statusText=d||this.statusTextFailed}else{if(b==5){this.statusText=this.statusTextDone}}}}}});this.store=new Ext.data.JsonStore({fields:["id","loaded","name","size","percent","status","msg"],listeners:{load:this.onStoreLoad,remove:this.onStoreRemove,update:this.onStoreUpdate,scope:this}});this.pbar=new Ext.ProgressBar({flex:1});this.bbar=new Ext.Toolbar({layout:"hbox",style:{paddingLeft:"5px"},items:[this.pbar,new Ext.Toolbar.TextItem({text:"<i>uploader not initialized</i>",itemId:"status"})]});this.tbar=new Ext.Toolbar({enableOverflow:true,items:[new Ext.Button({text:a.addButtonText||"Add files",itemId:"addButton",iconCls:a.addButtonCls,disabled:true}),new Ext.Button({text:a.uploadButtonText||"Upload",handler:this.onStart,scope:this,disabled:true,itemId:"start",iconCls:a.uploadButtonCls}),new Ext.Button({text:a.cancelButtonText||"Cancel",handler:this.onCancel,scope:this,disabled:true,itemId:"cancel",iconCls:a.cancelButtonCls}),new Ext.SplitButton({text:a.deleteButtonText||"Remove",handler:this.onDeleteSelected,menu:new Ext.menu.Menu({items:[{text:a.deleteSelectedText||"<b>Remove selected</b>",handler:this.onDeleteSelected,scope:this},"-",{text:a.deleteUploadedText||"Remove uploaded",handler:this.onDeleteUploaded,scope:this},"-",{text:a.deleteAllText||"Remove all",handler:this.onDeleteAll,scope:this}]}),scope:this,disabled:true,itemId:"delete",iconCls:a.deleteButtonCls})]});this.view=new Ext.DataView({store:this.store,tpl:this.viewTpl,multiSelect:true,overClass:"plupload_over",selectedClass:"plupload_selected",itemSelector:"dl",emptyText:a.emptyText||'<div class="plupload_emptytext"><span>Queue is empty</span></div>',emptyDropText:a.emptyDropText||'<div class="plupload_emptytext"><span>Drop files here</span></div>',deferEmptyText:false,plugins:Ext.DataView.DragSelector?new Ext.DataView.DragSelector():""});this.items=this.view;Ext.ux.PluploadPanel.superclass.constructor.apply(this,arguments)},initComponent:function(){Ext.ux.PluploadPanel.superclass.initComponent.apply(this,arguments)},afterRender:function(){Ext.ux.PluploadPanel.superclass.afterRender.apply(this,arguments);this.initialize_uploader()},onDeleteSelected:function(){Ext.each(this.view.getSelectedRecords(),function(a){this.remove_file(a.get("id"))},this)},onDeleteAll:function(){this.store.each(function(a){this.remove_file(a.get("id"))},this)},onDeleteUploaded:function(){this.store.each(function(a){if(a.get("status")==5){this.remove_file(a.get("id"))}},this)},onCancel:function(){this.uploader.stop()},onStart:function(){this.fireEvent("beforestart",this);if(this.multipart_params){this.uploader.settings.multipart_params=this.multipart_params}this.uploader.start()},initialize_uploader:function(){var runtimes="gears,browserplus,html5";if(this.flash_swf_url){runtimes="flash,"+runtimes}if(this.silverlight_xap_url){runtimes="silverlight,"+runtimes}this.uploader=new plupload.Uploader({url:this.url,runtimes:this.runtimes||runtimes,browse_button:this.getTopToolbar().getComponent("addButton").getEl().dom.id,container:this.getTopToolbar().getEl().dom.id,max_file_size:this.max_file_size||"10mb",resize:this.resize||"",flash_swf_url:this.flash_swf_url||"",silverlight_xap_url:this.silverlight_xap_url||"",filters:this.filters||[],chunk_size:this.chunk_size,unique_names:this.unique_names,multipart:this.multipart,multipart_params:this.multipart_params,drop_element:this.body.dom.id,required_features:this.required_features});Ext.each(["Init","ChunkUploaded","FilesAdded","FilesRemoved","FileUploaded","PostInit","QueueChanged","Refresh","StateChanged","UploadFile","UploadProgress","Error"],function(v){this.uploader.bind(v,eval("this."+v),this)},this);this.uploader.init()},remove_file:function(b){var a=this.uploader.getFile(b);if(a){this.uploader.removeFile(a)}else{this.store.remove(this.store.getById(b))}},update_pbar:function(){var i=this.uploader.total;var c=Ext.util.Format.fileSize(i.bytesPerSec);var g=this.store.data.length;var d=this.failed.length;var h=this.success.length;var f=d+h;var a=g-h-d;if(g){this.progressText="";var b=String.format(this.progressText||"{2} of {1} uploaded ({5}/s)",f,g,h,d,a,c);var e=i.percent/100;if(this.runtime=="flash"||this.runtime=="html4"){if(g==f||this.store.find("status",/1|2/)==-1){e=1}}this.pbar.updateProgress(e,b)}else{this.pbar.updateProgress(0," ")}},update_store:function(a){if(!a.msg){a.msg=""}var b=this.store.getById(a.id);if(b){b.data=a;b.commit()}else{this.store.loadData(a,true)}},onStoreLoad:function(c,a,b){this.update_pbar()},onStoreRemove:function(c,a,b){if(!c.data.length){this.getTopToolbar().getComponent("delete").setDisabled(true);this.getTopToolbar().getComponent("start").setDisabled(true);this.uploader.total.reset()}var d=a.get("id");Ext.each(this.success,function(e){if(e&&e.id==d){this.success.remove(e)}},this);Ext.each(this.failed,function(e){if(e&&e.id==d){this.failed.remove(e)}},this);this.update_pbar()},onStoreUpdate:function(c,a,b){this.update_pbar()},Init:function(d,c){var e=this.getBottomToolbar();var b=e.getComponent("status");this.runtime=c.runtime;if(this.runtime_visible==true){b.setText(" Uploader runtime: "+this.runtime)}else{b.setText("")}e.syncSize();if(this.uploader.features.dragdrop){var a=this.view;a.emptyText=this.emptyDropText;if(a.rendered){a.refresh()}}this.getTopToolbar().getComponent("addButton").setDisabled(false)},ChunkUploaded:function(){},FilesAdded:function(b,a){this.getTopToolbar().getComponent("delete").setDisabled(false);this.getTopToolbar().getComponent("start").setDisabled(false);Ext.each(a,function(c){this.update_store(c)},this)},FilesRemoved:function(b,a){Ext.each(a,function(c){this.store.remove(this.store.getById(c.id))},this)},FileUploaded:function(d,c,a){var b=Ext.util.JSON.decode(a.response);if(b.success==true){c.server_error=0;this.success.push(c)}else{if(b.message){c.msg='<span style="color: red">'+b.message+"</span>"}c.server_error=1;this.failed.push(c)}this.update_store(c)},PostInit:function(){},QueueChanged:function(a){},Refresh:function(a){Ext.each(a.files,function(b){this.update_store(b)},this)},StateChanged:function(a){if(a.state==2){this.fireEvent("uploadstarted",this);this.getTopToolbar().getComponent("cancel").setDisabled(false);this.getTopToolbar().getComponent("start").setDisabled(true)}else{this.fireEvent("uploadcomplete",this,this.success,this.failed);this.getTopToolbar().getComponent("cancel").setDisabled(true);this.getTopToolbar().getComponent("start").setDisabled(false)}},UploadFile:function(){},UploadProgress:function(b,a){if(a.server_error){a.status=4}this.update_store(a)},Error:function(b,a){a.file.status=4;if(a.code==-600){a.file.msg=String.format('<span style="color: red">{0}</span>',this.statusInvalidSizeText||"Too big")}else{if(a.code==-700){a.file.msg=String.format('<span style="color: red">{0}</span>',this.statusInvalidExtensionText||"Invalid file type")}else{a.file.msg=String.format('<span style="color: red">{2} ({0}: {1})</span>',a.code,a.details,a.message)}}this.update_store(a.file)}});Ext.reg("pluploadpanel",Ext.ux.PluploadPanel);Ext.ux.PluploadButton=Ext.extend(Ext.Button,{constructor:function(a){this.uploadpanel=new Ext.ux.PluploadPanel(a.upload_config);this.window=new Ext.Window({title:a.window_title||a.text||"Upload files",width:a.window_width||640,height:a.window_height||380,layout:"fit",items:this.uploadpanel,closeAction:"hide",listeners:{hide:function(b){if(this.clearOnClose){this.uploadpanel.onDeleteAll()}},scope:this}});this.handler=function(){this.window.show();this.uploadpanel.doLayout()};Ext.ux.PluploadButton.superclass.constructor.apply(this,arguments)}});Ext.reg("pluploadbutton",Ext.ux.PluploadButton);